'use strict';

var child_process = require('child_process');
var fs = require('fs-extra');
var path = require('path');
var util = require('util');
var PackageGraph = require('./PackageGraph-84e587f4.cjs.js');
var index = require('./index-d2845aa8.cjs.js');
require('@manypkg/get-packages');
require('@backstage/errors');
require('./Lockfile-e5943b84.cjs.js');
require('semver');
require('@yarnpkg/parsers');
require('@yarnpkg/lockfile');
require('minimatch');
require('chalk');
require('./yarn-8315d2ff.cjs.js');
require('./run-eac5f3ab.cjs.js');
require('commander');
require('@backstage/cli-common');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var fs__default = /*#__PURE__*/_interopDefaultLegacy(fs);

const execFile = util.promisify(child_process.execFile);
async function command() {
  const packages = await PackageGraph.PackageGraph.listTargetPackages();
  await fs__default["default"].remove(index.paths.resolveTargetRoot("dist"));
  await fs__default["default"].remove(index.paths.resolveTargetRoot("dist-types"));
  await fs__default["default"].remove(index.paths.resolveTargetRoot("coverage"));
  await Promise.all(
    Array.from(Array(10), async () => {
      var _a;
      while (packages.length > 0) {
        const pkg = packages.pop();
        const cleanScript = (_a = pkg.packageJson.scripts) == null ? void 0 : _a.clean;
        if (cleanScript === "backstage-cli clean" || cleanScript === "backstage-cli package clean") {
          await fs__default["default"].remove(path.resolve(pkg.dir, "dist"));
          await fs__default["default"].remove(path.resolve(pkg.dir, "dist-types"));
          await fs__default["default"].remove(path.resolve(pkg.dir, "coverage"));
        } else if (cleanScript) {
          const result = await execFile("yarn", ["run", "clean"], {
            cwd: pkg.dir,
            shell: true
          });
          process.stdout.write(result.stdout);
          process.stderr.write(result.stderr);
        }
      }
    })
  );
}

exports.command = command;
//# sourceMappingURL=clean-cd01f9dc.cjs.js.map
